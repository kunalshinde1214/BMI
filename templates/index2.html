<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BMI Data Dashboard</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700" rel="stylesheet">
  <!-- PapaParse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    /* Improved CSS styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background: #f0f2f5;
      color: #333;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }

    header {
      background: linear-gradient(135deg, #4facfe, #00f2fe);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      text-align: center;
      color: #fff;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    h2 {
      font-size: 22px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      color: #374151;
    }

    h3 {
      font-size: 20px;
      margin-bottom: 12px;
      color: #4b5563;
    }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 30px;
      overflow: hidden;
    }

    .card-content {
      padding: 24px;
    }

    .chart-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    @media (min-width: 768px) {
      .chart-container {
        grid-template-columns: 1fr 1fr;
      }
    }

    .chart-card {
      height: 320px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      background: #fafafa;
      position: relative;
    }

    .chart {
      width: 100%;
      height: 260px;
      position: relative;
    }

    .data-section {
      display: grid;
      grid-template-columns: 1fr;
      gap: 30px;
    }

    @media (min-width: 992px) {
      .data-section {
        grid-template-columns: 2fr 1fr;
      }
    }

    .search-container {
      position: relative;
      margin-bottom: 16px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 10px;
      color: #9ca3af;
    }

    .search-input {
      width: 100%;
      padding: 10px 10px 10px 36px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 15px;
    }

    .search-summary {
      font-size: 14px;
      color: #6b7280;
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f3f4f6;
    }

    th, td {
      padding: 14px 20px;
      text-align: left;
      font-size: 14px;
      border-top: 1px solid #e5e7eb;
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      color: #6b7280;
    }

    tr:hover {
      background: #f9fafb;
    }

    .sort-icon {
      margin-left: 6px;
    }

    .table-footer {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      color: #6b7280;
    }

    .info-card {
      background: #eff6ff;
      border: 1px solid #dbeafe;
      border-radius: 8px;
      padding: 20px;
    }

    .info-card h3 {
      color: #1e40af;
      margin-bottom: 10px;
    }

    .info-card p {
      font-size: 15px;
      color: #3b82f6;
      margin-bottom: 10px;
    }

    .info-card ul {
      margin-left: 20px;
      margin-top: 10px;
    }

    /* BMI category text colors */
    .text-underweight { color: #3B82F6; }
    .text-normal { color: #10B981; }
    .text-overweight { color: #F59E0B; }
    .text-obese { color: #EF4444; }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 260px;
      color: #6b7280;
      font-size: 16px;
    }

    /* Tooltip styles */
    .tooltip {
      position: absolute;
      background: #fff;
      padding: 8px;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      pointer-events: none;
      font-size: 14px;
      z-index: 100;
    }

    /* Header with icon */
    .header-with-icon {
      display: flex;
      align-items: center;
    }

    .header-icon {
      margin-right: 10px;
      color: #3b82f6;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>BMI Data Dashboard</h1>
      <p>Visualizing and Analyzing BMI Records</p>
    </header>

    <!-- Visualization Section -->
    <div class="card visualization-section">
      <div class="card-content">
        <h2 class="header-with-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="header-icon">
            <rect x="3" y="3" width="18" height="18" rx="2"></rect>
            <path d="M8 15v-6"></path>
            <path d="M12 15V9"></path>
            <path d="M16 15v-3"></path>
          </svg>
          BMI Distribution Visualization
        </h2>

        <div class="chart-container">
          <div class="chart-card">
            <h3>Overall BMI Distribution</h3>
            <div id="overall-chart" class="chart">
              <div class="loading">Loading chart data...</div>
            </div>
          </div>

          <div class="chart-card">
            <h3>BMI Distribution by Gender</h3>
            <div id="gender-chart" class="chart">
              <div class="loading">Loading chart data...</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Table Section -->
    <div class="data-section">
      <div>
        <h2>Existing BMI Records</h2>
        <div class="search-container">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon">
            <circle cx="10" cy="10" r="8"></circle>
            <line x1="17" y1="17" x2="22" y2="22"></line>
          </svg>
          <input type="text" id="search-input" class="search-input" placeholder="Search records...">
          <p id="search-summary" class="search-summary">Loading records...</p>
        </div>

        <div class="card">
          <div id="table-container">
            <div class="loading">Loading data...</div>
          </div>
        </div>
      </div>

      <!-- Info Card Section -->
      <div class="info-card">
        <h3>About BMI</h3>
        <p>Body Mass Index (BMI) is a measure derived from a person's weight and height. It is used as an indicator of body fatness.</p>
        <p>While BMI is useful for most people, it may overestimate body fat in athletes and underestimate it in individuals with low muscle mass.</p>
        <p>BMI Categories:</p>
        <ul>
          <li class="text-underweight">Underweight: &lt; 18.5</li>
          <li class="text-normal">Normal weight: 18.5 - 24.9</li>
          <li class="text-overweight">Overweight: 25 - 29.9</li>
          <li class="text-obese">Obese: ≥ 30</li>
        </ul>
      </div>
    </div>
  </div>

  <script>
    // State and data variables
    let data = [];
    let filteredData = [];
    let sortColumn = "Person ID A1";
    let sortDirection = "asc";
    let searchTerm = "";
    let chartData = [];
    let genderChartData = [];

    // BMI categories configuration
    const categories = {
      underweight: { min: 0, max: 18.5, label: "Underweight", color: "#3B82F6" },
      normal: { min: 18.5, max: 25, label: "Normal", color: "#10B981" },
      overweight: { min: 25, max: 30, label: "Overweight", color: "#F59E0B" },
      obese: { min: 30, max: 100, label: "Obese", color: "#EF4444" }
    };

    document.addEventListener('DOMContentLoaded', () => {
      fetchData();
      setupEventListeners();
    });

    // Fetch and parse CSV data
    async function fetchData() {
      try {
        const response = await fetch("https://hebbkx1anhila5yf.public.blob.vercel-storage.com/bmi_last-h3KUHprUepNRbWSG3cr6G5zg0qhYu1.csv");
        const text = await response.text();
        Papa.parse(text, {
          header: true,
          dynamicTyping: true,
          skipEmptyLines: true,
          complete: (results) => {
            data = results.data;
            filteredData = results.data;
            prepareChartData(results.data);
            renderTable();
            renderCharts();
            updateSearchSummary();
          },
          error: (error) => {
            console.error("Error parsing CSV:", error);
            document.querySelector("#table-container").innerHTML = "<div class='loading'>Error loading data</div>";
          }
        });
      } catch (error) {
        console.error("Error fetching CSV:", error);
        document.querySelector("#table-container").innerHTML = "<div class='loading'>Error loading data</div>";
      }
    }

    function setupEventListeners() {
      document.getElementById("search-input").addEventListener("input", (e) => {
        searchTerm = e.target.value;
        filterData();
      });
    }

    function filterData() {
      if (searchTerm.trim() === "") {
        filteredData = data;
      } else {
        filteredData = data.filter((row) => {
          return Object.values(row).some(
            (value) => value !== null && value.toString().toLowerCase().includes(searchTerm.toLowerCase())
          );
        });
      }
      sortData(sortColumn, sortDirection);
      renderTable();
      updateSearchSummary();
    }

    function sortData(column, direction) {
      sortColumn = column;
      sortDirection = direction;
      filteredData.sort((a, b) => {
        if (a[column] === null) return 1;
        if (b[column] === null) return -1;
        return direction === "asc" ? a[column] > b[column] ? 1 : -1 : a[column] < b[column] ? 1 : -1;
      });
      renderTable();
    }

    function handleSort(column) {
      const newDirection = sortColumn === column && sortDirection === "asc" ? "desc" : "asc";
      sortData(column, newDirection);
    }

    function prepareChartData(data) {
      const categoryCounts = { Underweight: 0, Normal: 0, Overweight: 0, Obese: 0 };
      const genderCounts = [
        { gender: "Male", Underweight: 0, Normal: 0, Overweight: 0, Obese: 0 },
        { gender: "Female", Underweight: 0, Normal: 0, Overweight: 0, Obese: 0 }
      ];

      data.forEach((row) => {
        const bmi = parseFloat(row["BMI"]);
        const gender = row["Gender"] === 1 ? "Male" : "Female";
        if (isNaN(bmi)) return;
        let category;
        if (bmi < categories.underweight.max) category = "Underweight";
        else if (bmi < categories.normal.max) category = "Normal";
        else if (bmi < categories.overweight.max) category = "Overweight";
        else category = "Obese";

        categoryCounts[category]++;
        if (gender === "Male") genderCounts[0][category]++;
        else genderCounts[1][category]++;
      });

      chartData = Object.entries(categoryCounts).map(([category, count]) => ({
        name: category,
        count,
        color: categories[category.toLowerCase()]?.color || "#6B7280"
      }));

      genderChartData = genderCounts;
    }

    function renderTable() {
      const tableContainer = document.getElementById("table-container");
      let tableHTML = `
        <table>
          <thead>
            <tr>
              ${["Person ID A1", "Gender", "Height", "Weight", "BMI"].map(column => `
                <th onclick="handleSort('${column}')">
                  <div style="display: flex; align-items: center;">
                    ${column}
                    ${sortColumn === column ? `<span class="sort-icon">${sortDirection === "asc" ? "↑" : "↓"}</span>` : ''}
                  </div>
                </th>
              `).join('')}
            </tr>
          </thead>
          <tbody>
      `;
      const displayData = filteredData.slice(0, 20);
      displayData.forEach(row => {
        const bmiValue = parseFloat(row["BMI"]);
        const bmiCategory = getBMICategory(bmiValue);
        tableHTML += `
          <tr>
            <td>${row["Person ID A1"]}</td>
            <td>${row["Gender"] === 1 ? "Male" : "Female"}</td>
            <td>${row["Height"]} m</td>
            <td>${row["Weight"]} kg</td>
            <td class="${bmiCategory.cssClass}">${row["BMI"]} (${bmiCategory.category})</td>
          </tr>
        `;
      });
      tableHTML += `</tbody></table>`;
      if (filteredData.length > 20) {
        tableHTML += `<div class="table-footer">Showing 20 of ${filteredData.length} records</div>`;
      }
      tableContainer.innerHTML = tableHTML;
    }

    function renderCharts() {
      renderOverallChart();
      renderGenderChart();
    }

    function renderOverallChart() {
      const chartContainer = document.getElementById("overall-chart");
      chartContainer.innerHTML = "";
      const maxCount = Math.max(...chartData.map(item => item.count));
      const chartHeight = 200;
      const chartWidth = chartContainer.offsetWidth - 60;
      const barWidth = Math.floor(chartWidth / chartData.length) - 40;
      
      let svg = `<svg width="100%" height="100%" viewBox="0 0 ${chartWidth + 60} ${chartHeight + 60}">
        <line x1="40" y1="10" x2="40" y2="${chartHeight + 10}" stroke="#e5e7eb" stroke-width="1" />
        <line x1="40" y1="${chartHeight + 10}" x2="${chartWidth + 40}" y2="${chartHeight + 10}" stroke="#e5e7eb" stroke-width="1" />
      `;
      chartData.forEach((item, index) => {
        const barHeight = (item.count / maxCount) * chartHeight;
        const x = 60 + (index * (barWidth + 40));
        const y = chartHeight + 10 - barHeight;
        svg += `
          <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}" fill="${item.color}"
            onmouseover="showTooltip(event, '${item.name}: ${item.count}')"
            onmouseout="hideTooltip()"
          />
          <text x="${x + barWidth/2}" y="${chartHeight + 30}" text-anchor="middle" font-size="12">${item.name}</text>
        `;
      });
      svg += `
        <text x="35" y="${chartHeight + 10}" text-anchor="end" font-size="12">0</text>
        <text x="35" y="${chartHeight/2 + 10}" text-anchor="end" font-size="12">${Math.floor(maxCount/2)}</text>
        <text x="35" y="15" text-anchor="end" font-size="12">${maxCount}</text>
        <text x="${(chartWidth + 60)/2}" y="${chartHeight + 50}" text-anchor="middle" font-size="14">BMI Categories</text>
      </svg>`;
      chartContainer.innerHTML = svg;
    }

    function renderGenderChart() {
      const chartContainer = document.getElementById("gender-chart");
      chartContainer.innerHTML = "";
      const categoriesArr = ["Underweight", "Normal", "Overweight", "Obese"];
      const colors = ["#3B82F6", "#10B981", "#F59E0B", "#EF4444"];
      const chartHeight = 200;
      const chartWidth = chartContainer.offsetWidth - 60;
      let maxValue = 0;
      genderChartData.forEach(gender => {
        categoriesArr.forEach(cat => {
          if (gender[cat] > maxValue) maxValue = gender[cat];
        });
      });
      const barGroupWidth = Math.floor(chartWidth / genderChartData.length) - 40;
      const barWidth = Math.floor(barGroupWidth / categoriesArr.length) - 2;
      let svg = `<svg width="100%" height="100%" viewBox="0 0 ${chartWidth + 60} ${chartHeight + 90}">
        <line x1="40" y1="10" x2="40" y2="${chartHeight + 10}" stroke="#e5e7eb" stroke-width="1" />
        <line x1="40" y1="${chartHeight + 10}" x2="${chartWidth + 40}" y2="${chartHeight + 10}" stroke="#e5e7eb" stroke-width="1" />
      `;
      genderChartData.forEach((genderData, gIndex) => {
        const x = 60 + (gIndex * (barGroupWidth + 40));
        svg += `<text x="${x + barGroupWidth/2}" y="${chartHeight + 30}" text-anchor="middle" font-size="12">${genderData.gender}</text>`;
        categoriesArr.forEach((category, cIndex) => {
          const barHeight = (genderData[category] / maxValue) * chartHeight;
          const barX = x + (cIndex * (barWidth + 2));
          const barY = chartHeight + 10 - barHeight;
          svg += `
            <rect x="${barX}" y="${barY}" width="${barWidth}" height="${barHeight}" fill="${colors[cIndex]}"
              onmouseover="showTooltip(event, '${genderData.gender}, ${category}: ${genderData[category]}')"
              onmouseout="hideTooltip()"
            />
          `;
        });
      });
      svg += `<g transform="translate(40, ${chartHeight + 50})">`;
      categoriesArr.forEach((category, index) => {
        svg += `<rect x="${index * 120}" y="0" width="12" height="12" fill="${colors[index]}" />
                <text x="${index * 120 + 18}" y="10" font-size="12">${category}</text>`;
      });
      svg += `</g>
        <text x="35" y="${chartHeight + 10}" text-anchor="end" font-size="12">0</text>
        <text x="35" y="${chartHeight/2 + 10}" text-anchor="end" font-size="12">${Math.floor(maxValue/2)}</text>
        <text x="35" y="15" text-anchor="end" font-size="12">${maxValue}</text>
      </svg>`;
      chartContainer.innerHTML = svg;
    }

    function getBMICategory(bmi) {
      if (bmi < 18.5) return { category: "Underweight", cssClass: "text-underweight" };
      if (bmi < 25) return { category: "Normal weight", cssClass: "text-normal" };
      if (bmi < 30) return { category: "Overweight", cssClass: "text-overweight" };
      return { category: "Obese", cssClass: "text-obese" };
    }

    function updateSearchSummary() {
      const searchSummary = document.getElementById("search-summary");
      searchSummary.textContent = `Showing ${filteredData.length} of ${data.length} records`;
    }

    function showTooltip(event, text) {
      hideTooltip();
      const tooltip = document.createElement('div');
      tooltip.className = 'tooltip';
      tooltip.id = 'chart-tooltip';
      tooltip.textContent = text;
      tooltip.style.left = (event.pageX + 10) + 'px';
      tooltip.style.top = (event.pageY - 30) + 'px';
      document.body.appendChild(tooltip);
    }

    function hideTooltip() {
      const tooltip = document.getElementById('chart-tooltip');
      if (tooltip) tooltip.remove();
    }

    window.addEventListener('resize', () => {
      if (chartData.length > 0) renderCharts();
    });
  </script>
</body>
</html>
